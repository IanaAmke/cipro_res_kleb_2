---
title: "Ciprofloxacin resistance in Klebsiella pneumoniae"
author: "Iana Amke"
date: "2022-11-03"
output: 
  html_document:
    df_print: paged
    fig_width: 10
    fig_height: 8
editor_options: 
  chunk_output_type: inline
---
<style type="text/css">
.main-container {
  max-width: 1500px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Functions 
```{r}
# create UpSet plots for AST measurements and fluoroquinolone resistance mechanisms
upset_plot <- function(df, x, y) {
# df - dataframe; x - Flq resistance mechanism column; y - Laboratory typing method column
  require(dplyr, ggplot2, ggupset)
  
  # checks if lab typing method is MIC or disk diffusion 
  if (grepl('MIC.*$', df[y])) {
    df %>%
      group_by(strain, Measurement) %>% 
      summarize(res_mech_list = list(!! sym(x))) %>%
      ggplot(aes(res_mech_list, Measurement)) + geom_violin() + geom_count() + 
      # EUCAST cut-off of 0.5 mg/L
      geom_hline(aes(yintercept = 0.5, linetype = "EUCAST"), alpha = 0.6, color = "black") +
      # CLSI cut-off of 1 mg/L
      geom_hline(aes(yintercept = 1.0, linetype = "CLSI"), color = "black") +
      labs(x = "Fluoroquinolone resistance mutations", y = "Ciprofloxacin MIC measurement (mg/L)",
           size = "Number of strains", linetype = "MIC breakpoints") +
      # convert y-axis to log2 scale and labels to 2 dp
      scale_y_continuous(trans = log2_trans(), breaks = 2^(-5:9), labels = function(x) round(as.numeric(x), digits = 2)) +
      scale_linetype_manual(values = c("dotted", "solid")) +
      scale_x_upset() +
      theme_combmatrix(combmatrix.panel.line.size = 0.8)
  } else {
      df %>%
        group_by(strain, Measurement) %>% 
        summarize(res_mech_list = list(!! sym(x))) %>%
        ggplot(aes(res_mech_list, Measurement)) + geom_violin() + geom_count() + 
        # EUCAST cut-off of 22mm
        geom_hline(aes(yintercept = 22, linetype = "EUCAST"), alpha = 0.6, color = "black") +
        # CLSI cut-off of 21mm
        geom_hline(aes(yintercept = 21, linetype = "CLSI"), color = "black") +
        labs(title = "Disk diffusion measurements", x = 
               "Fluoroquinolone resistance mutations", y = "Ciprofloxacin disk diffusion measurement (mm)", 
             size = "Number of strains", linetype = "Disk diffusion breakpoints") +
        scale_linetype_manual(values = c("dotted", "solid")) +
        scale_x_upset() +
        theme_combmatrix(combmatrix.panel.line.size = 0.8)
  }
}
```

# Load required libraries
```{r message=FALSE}
library(here)
library(tidyverse)
library(scales)
library(ggupset)
```

# Load antibiogram data and filter for ciprofloxacin
```{r}
# read antibiogram data
antibiogram <- read.delim(file = "antibiogram_combined.tsv", 
                                header = TRUE, sep = "\t")

# filter for ciprofloxacin
cipro_antibiogram <- antibiogram %>%
  filter(Antibiotic == "ciprofloxacin") %>%
  select(strain:ST, Flq_mutations, Flq_acquired, Omp_mutations, Antibiotic:Measurement.Round) %>%
  mutate(Resistance.phenotype = case_when(grepl('MIC.*$', Laboratory.Typing.Method) & Measurement <= 0.25 ~ 
                                            "susceptible",
                                          grepl('MIC.*$', Laboratory.Typing.Method) & Testing.standard == 
                                            "EUCAST" & Measurement > 0.5 ~ "resistant",
                                          grepl('MIC.*$', Laboratory.Typing.Method) & Testing.standard == 
                                            "CLSI" & Measurement >= 1 ~ "resistant",
                                          Laboratory.Typing.Method == "Disk diffusion" & Testing.standard == 
                                            "EUCAST" & Measurement >= 25 ~ "susceptible",
                                          Laboratory.Typing.Method == "Disk diffusion" & Testing.standard == 
                                            "EUCAST" & Measurement < 22 ~ "resistant",
                                          Laboratory.Typing.Method == "Disk diffusion" & Testing.standard == 
                                            "CLSI" & Measurement >= 26 ~ "susceptible",
                                          Laboratory.Typing.Method == "Disk diffusion" & Testing.standard == 
                                            "CLSI" & Measurement <= 21 ~ "resistant",
                                          TRUE ~ "intermediate"))

#write_delim(cipro_antibiogram, file = "cipro_antibiogram.tsv", delim = "\t")

# combine antibiogram with mutations not in kleborate data file
no_mut_kleborate <- read.delim(file = "cipro_res_kleb/mutations_not_in_kleborate.tsv",
                               header = TRUE, sep = "\t")

cipro_antibiogram <- cipro_antibiogram %>%
  left_join(no_mut_kleborate, by = c("strain")) %>%
  mutate(Flq_mutations = case_when(Flq_mutations.y %in% NA ~ Flq_mutations.x, 
                                   Flq_mutations.x == "-" & Flq_mutations.y %in% NA ~ Flq_mutations.x,
                                   TRUE ~ Flq_mutations.y)) %>%
  select(- c(Flq_mutations.x, Flq_mutations.y)) %>%
  relocate(Flq_mutations, .after = ST)
```

# Summaries
## Sample count per dataset
```{r fig.align='center'}
cipro_antibiogram %>%
  group_by(index) %>%
  ggplot(aes(x = index)) +
  geom_bar(fill = "#ff8000", alpha = 0.6) +
  geom_text(aes(label = ..count..), stat = "count", nudge_y = 60) +
  labs(title = "Total sample count per dataset", y = "Total sample count", fill = "Lab typing method") +
  theme(axis.title.x = element_blank(), axis.text.x = element_text(angle = 45, hjust = 1))
```

## AST testing standards summary
```{r fig.align='center'}
cipro_antibiogram %>%
  group_by(Testing.standard) %>%
  ggplot(aes(Testing.standard, fill = Testing.standard.year.or.version)) +
  geom_bar(alpha = 0.7) +
  labs(title = "Total sample count per testing standard", x = "Testing standard", y = "Total sample count", 
       fill = "Testing standard\n(year or version)")
```

## Total sample counts vs measurements for different lab typing methods
### Disk diffusion
```{r fig.align='center'}
cipro_antibiogram %>%
  group_by(Laboratory.Typing.Method) %>%
  filter(Laboratory.Typing.Method == "Disk diffusion") %>%
  ggplot(aes(Measurement, fill = index)) + geom_bar() + 
  # EUCAST cut-off of 22mm
  geom_vline(aes(xintercept = 22, linetype = "EUCAST"), color = "black") +
  # CLSI cut-off of 21mm
  geom_vline(aes(xintercept = 21, linetype = "CLSI"), color = "black") +
  labs(title = "Disk Diffusion Measurements", x = "Measurement (mm)", y = "Frequency", fill = "Dataset", 
       linetype = "Disk diffusion \nECOFF cut-off") +
  scale_linetype_manual(values = c("dotted", "solid"))
```

### MIC
#### MIC (broth dilution)
```{r fig.align='center'}
cipro_antibiogram %>%
  group_by(Laboratory.Typing.Method) %>%
  filter(Laboratory.Typing.Method == "MIC (broth dilution)") %>%
  ggplot(aes(x = factor(Measurement), fill = index)) + geom_bar() + 
  # EUCAST cut-off of 0.5 mg/L
  geom_vline(aes(xintercept = 6, linetype = "EUCAST"), alpha = 0.6, color = "black") +
  # CLSI cut-off of 1 mg/L
  geom_vline(aes(xintercept = 8, linetype = "CLSI"), color = "black") +
  labs(title = "MIC Broth Dilution Measurements", x = "Measurement (mg/L)", y = "Frequency", fill = "Dataset", 
       linetype = "MIC ECOFF cut-off") +
  scale_linetype_manual(values = c("dotted", "solid")) 
```

#### MIC (agar dilution)
```{r fig.align='center'}
cipro_antibiogram %>%
  group_by(Laboratory.Typing.Method) %>%
  filter(Laboratory.Typing.Method == "MIC (agar dilution)") %>%
  ggplot(aes(x = factor(Measurement), fill = index)) + geom_bar() + 
  # EUCAST cut-off of 0.5 mg/L
  geom_vline(aes(xintercept = 5, linetype = "EUCAST"), alpha = 0.6, color = "black") +
  # CLSI cut-off of 1 mg/L
  geom_vline(aes(xintercept = 6, linetype = "CLSI"), color = "black") +
  labs(title = "MIC Agar Dilution Measurements", x = "Measurement (mg/L)", y = "Frequency", fill = "Dataset", 
       linetype = "MIC ECOFF cut-off") +
  # round off x-axis labels to 2dp
  scale_x_discrete(labels = function(x) round(as.numeric(x), digits = 2)) +
  scale_linetype_manual(values = c("dotted", "solid")) 
```

# UpSet plots for different lab typing methods to visualise resistance mechanism combinations
## Combine Flq_mutations, Flq_acquired and Omp_mutations into one column
```{r}
cipro_res_mech <- cipro_antibiogram %>%
  pivot_longer(Flq_mutations:Omp_mutations, names_to = "Flq.resistance.mech", 
               values_to = "Resistance.mech.type") %>%
  separate(Resistance.mech.type, into = c("type_A", "type_B", "type_C"), sep = "[;]")

cipro_res_mech <- cipro_res_mech %>%
  pivot_longer(cols = names(cipro_res_mech)[26:28], values_to = "Resistance.mech.type") %>%
  drop_na(Resistance.mech.type) %>%
  select(-name) 

view(cipro_res_mech)
```

## UpSet plots
### MIC
#### MIC (broth dilution)
```{r warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE)
p <- cipro_res_mech %>%
  filter(Laboratory.Typing.Method == "MIC (broth dilution)") %>%
  upset_plot("Resistance.mech.type", "Laboratory.Typing.Method") +
  labs(title = "MIC (broth dilution) measurements") 
```

<style>
  .bigupsetplot{
      overflow-x:scroll !important;
      white-space: nowrap;
      max-width: 1500px;
      max-height: 1500px:
  }
  .bigupsetplot img{
     max-width: 300%;
  }
</style>

<div class="bigupsetplot">
```{r echo=FALSE, fig.height=35, fig.width=55, warning=FALSE, cache=FALSE}
# this produces the plot with a special css class (scrollable figure)
p
```
</div>

#### MIC (agar dilution)
```{r warning=FALSE, fig.width=15, fig.height=15}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      dpi = 300, cache = FALSE, attr.output = 'style="max-height: 300px;"')
cipro_res_mech %>%
  filter(Laboratory.Typing.Method == "MIC (agar dilution)") %>%
  upset_plot("Resistance.mech.type", "Laboratory.Typing.Method") +
  labs(title = "MIC (agar dilution) measurements") 
```

### Disk diffusion
```{r warning=FALSE, fig.width=20, fig.height=20}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE,
                      dpi = 300, cache = FALSE, attr.output = 'style="max-height: 300px;"')

cipro_res_mech %>%
  filter(Laboratory.Typing.Method == "Disk diffusion") %>%
  upset_plot("Resistance.mech.type", "Laboratory.Typing.Method")
```

# ST analysis
## Resistant strains displaying fluoroquinolone resistance mechanisms
### ST count 
```{r fig.width=10, fig.height=8, fig.align='center'}
# count STs with resistant phenotype
top_35_st_res <- cipro_antibiogram %>%
  filter(Resistance.phenotype == "resistant") %>%
  group_by(ST) %>%
  summarise(sample_count = n()) %>%
  as.data.frame() %>%
  arrange(desc(sample_count)) %>%
  head(35) %>%
  mutate(ST = factor(ST, levels = ST, ordered = TRUE))

top_35_st_res

top_35_st_res %>%
  ggplot(aes(y = ST, x = sample_count, fill = ST, label = sample_count)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(hjust = -0.5) +
  scale_y_discrete(limits = rev) +
  ggtitle("Top STs with fluoroquinolone resistance") +
  labs(x = "Sample count") +
  theme_minimal() +
  theme(legend.position = "none",
  axis.text = element_text(size = 11)) +
  annotate("text", x = -10, y = 36, label = "") +
  annotate("text", x = 10, y = 36, label = "") +
  coord_cartesian(clip = "off")
```

### STs associated with specific fluoroquinolone resistance mechanisms
```{r fig.width=20, fig.height=10, fig.align='center'}
st_res_mech <- cipro_res_mech %>%
  filter(Resistance.phenotype == "resistant") %>%
  filter(Resistance.mech.type != "-") %>%
  group_by(ST) %>%
  summarise(res_mech = Resistance.mech.type) %>%
  as.data.frame() %>%
  count(ST, res_mech, sort = TRUE) %>%
  filter(n > 15) %>%
  mutate(ST = factor(ST, levels = unique(ST)))

st_res_mech

st_res_mech %>%
  ggplot(aes(ST, n, fill = res_mech)) +
  geom_bar(stat = "identity") +
  labs(title = "Top STs associated with specific fluoroquinolone resistance mechanisms", y = "Count", fill = "Fluoroquinolone resistance\nmechanisms") +
  # put legend in one column
  guides(fill = guide_legend(ncol = 1))
```

## Resistant strains displaying no fluoroquinolone resistance mechanisms
```{r}
no_res_mech <- cipro_antibiogram %>%
  filter(Flq_mutations == "-", Flq_acquired == "-", Omp_mutations == "-") %>%
  filter(Resistance.phenotype == "resistant")

st_no_res_mech <- no_res_mech %>%
  group_by(ST) %>%
  summarise(sample_count = n()) %>%
  as.data.frame() %>%
  arrange(desc(sample_count)) %>%
  mutate(ST = factor(ST, levels = ST, ordered = TRUE))

st_no_res_mech
```

## Susceptible strains displaying fluoroquinolone resistance mechanisms
```{r fig.width=20, fig.height=10, fig.align='center'}
sus_res_mech <- cipro_res_mech %>%
  filter(Resistance.phenotype == "susceptible") %>%
  filter(Resistance.mech.type != "-")

st_sus_res_mech <- sus_res_mech %>%
  group_by(ST) %>%
  summarise(res_mech = Resistance.mech.type) %>%
  as.data.frame() %>%
  count(ST, res_mech, sort = TRUE) %>%
  filter(n != 1) %>%
  mutate(ST = factor(ST, levels = unique(ST)))

st_sus_res_mech 

st_sus_res_mech %>%
  ggplot(aes(ST, n, fill = res_mech)) +
  geom_bar(stat = "identity") +
  labs(title = "Top susceptible STs associated with specific fluoroquinolone resistance mechanisms", y = "Count", fill = "Fluoroquinolone resistance\nmechanisms") +
  # put legend in one column
  guides(fill = guide_legend(ncol = 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### UpSet plots
#### Disk diffusion
```{r warning=FALSE, fig.width=10, fig.height=10, fig.align='center'}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE,
                      dpi = 300, cache = FALSE, attr.output = 'style="max-height: 300px;"')

sus_res_mech %>%
  filter(Laboratory.Typing.Method == "Disk diffusion") %>%
  upset_plot("Resistance.mech.type", "Laboratory.Typing.Method")
```

#### MIC (broth dilution)
```{r warning=FALSE, fig.width=10, fig.height=10, fig.align='center'}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      dpi = 300, cache = FALSE, attr.output = 'style="max-height: 300px;"')
sus_res_mech %>%
  filter(Laboratory.Typing.Method == "MIC (broth dilution)") %>%
  upset_plot("Resistance.mech.type", "Laboratory.Typing.Method") +
  labs(title = "MIC (broth dilution) measurements") 
```

#### MIC (agar dilution)
```{r warning=FALSE, fig.width=10, fig.height=10, fig.align='center'}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      dpi = 300, cache = FALSE, attr.output = 'style="max-height: 300px;"')
sus_res_mech %>%
  filter(Laboratory.Typing.Method == "MIC (agar dilution)") %>%
  upset_plot("Resistance.mech.type", "Laboratory.Typing.Method") +
  labs(title = "MIC (agar dilution) measurements") 
```

